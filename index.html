<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Festival Planner</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: sans-serif; padding: 1em; background: #f0f0f0; }
    h2 { text-align: center; }
    #nickname { width: 100%; padding: 0.5em; margin: 1em 0; font-size: 1em; }
    .card {
      background: #fff; border-radius: 8px; padding: 1em; margin-bottom: 1em;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .artist { font-size: 1.2em; font-weight: bold; }
    .info    { color: #555; margin: 0.5em 0; }
    .attendees { margin: 0.5em 0; font-size: 0.9em; color: #333; }
    button {
      padding: 0.5em 1em; border: none; border-radius: 4px;
      font-size: 0.9em; cursor: pointer;
    }
    .join  { background: #28a745; color: white; }
    .leave { background: #dc3545; color: white; }
    .loading { text-align: center; color: #888; margin: 1em 0; }
  </style>
</head>
<body>
  <h2>ðŸŽµ Festival Signup</h2>
  <input id="nickname" placeholder="Enter your nickname" />

  <div id="schedule"></div>

  <script>
    // â† REPLACE with your Apps Script Web App URL (must end in /exec)
    const backend = 'https://script.google.com/macros/s/AKfycby8Ikg95Fn4AKbKzHOdEBaNPNrISll8Z_PfrZs7hR5alJbMVkHybvguZY6d_tmSthA9bg/exec';

    let me = '';
    const scheduleEl = document.getElementById('schedule');
    const nicknameEl = document.getElementById('nickname');

    nicknameEl.addEventListener('change', e => {
      me = e.target.value.trim();
      loadSchedule();
    });

    // Show loading text, then inject JSONP
    function loadSchedule() {
      scheduleEl.innerHTML = '<div class="loading">Loading scheduleâ€¦</div>';
      const script = document.createElement('script');
      script.src = `${backend}?callback=render&nocache=${Date.now()}`;
      document.body.appendChild(script);
    }

    // Render data into cards
    function render(data) {
      scheduleEl.innerHTML = '';  // clear loading
      data.forEach(item => {
        const names  = (item.Attendees || '').split(',').map(s=>s.trim()).filter(Boolean);
        const joined = me && names.includes(me);
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="artist">${item.Artist}</div>
          <div class="info">${item.Time} @ ${item.Stage}</div>
          <div class="attendees">ðŸ‘¥ ${names.length ? names.join(', ') : 'No one yet'}</div>
          <button class="${joined ? 'leave' : 'join'}"
                  onclick="toggle(${item.rowIndex}, event)">
            ${ joined ? 'Leave' : 'Join' }
          </button>
        `;
        scheduleEl.appendChild(card);
      });
    }

    // Toggle attendance with single JSONP call & loading indicator per button
    function toggle(row, event) {
      if (!me) {
        alert('Please enter your nickname first.');
        return;
      }
      const btn = event.currentTarget;
      btn.disabled = true;
      const originalText = btn.textContent;
      btn.textContent = 'â³';

      const script = document.createElement('script');
      script.src = `${backend}`
        + `?action=toggle`
        + `&rowIndex=${row}`
        + `&nickname=${encodeURIComponent(me)}`
        + `&callback=render`;
      document.body.appendChild(script);

      // Optional: re-enable & reset button in case render fails
      setTimeout(() => {
        if (btn.disabled) {
          btn.disabled = false;
          btn.textContent = originalText;
        }
      }, 5000);
    }

    // Initial load
    loadSchedule();
  </script>
</body>
</html>
