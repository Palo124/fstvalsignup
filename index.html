<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Festival Planner</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: sans-serif; margin: 0; padding: 1em; background: #f0f0f0; }
    h2 { text-align: center; }
    #tabs { display: flex; gap: 0.5em; justify-content: center; margin-bottom: 1em; }
    #tabs button {
      padding: 0.5em 1em; border: none; border-radius: 4px;
      background: #ddd; cursor: pointer;
    }
    #tabs button.active { background: #007bff; color: #fff; }
    #controls {
      display: flex; gap: 0.5em; flex-wrap: wrap; margin-bottom: 1em;
      justify-content: center;
    }
    #nickname, #filterSelect {
      padding: 0.5em; font-size: 1em; border-radius: 4px; border: 1px solid #ccc;
      width: 200px;
    }
    .loading { text-align: center; color: #666; margin: 1em 0; }
    .card {
      background: #fff; padding: 1em; margin-bottom: 1em;
      border-radius: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      border-left: 6px solid transparent;
      transition: background 0.2s;
    }
    .card:hover { background: #fafafa; }
    .artist { font-size: 1.2em; font-weight: bold; }
    .info    { color: #555; margin: 0.5em 0; }
    .attendees { color: #333; font-size: 0.9em; margin: 0.5em 0; }
    button.join { background: #28a745; color: #fff; border-radius: 4px; padding: 0.3em 0.8em; }
    button.leave{ background: #dc3545; color: #fff; border-radius: 4px; padding: 0.3em 0.8em; }
  </style>
</head>
<body>
  <h2>🎵 Festival Signup</h2>

  <div id="tabs">
    <!-- adjust these to match your sheet names -->
    <button data-day="Day1" class="active">Day 1</button>
    <button data-day="Day2">Day 2</button>
    <button data-day="Day3">Day 3</button>
  </div>

  <div id="controls">
    <input id="nickname" placeholder="Your nickname">
    <select id="filterSelect">
      <option value="">All attendees</option>
    </select>
  </div>

  <div id="schedule"></div>

  <script>
    const backend = 'https://script.google.com/macros/s/AKfycby8Ikg95Fn4AKbKzHOdEBaNPNrISll8Z_PfrZs7hR5alJbMVkHybvguZY6d_tmSthA9bg/exec';  // ← your /exec URL

    let me = '', currentDay = 'Day1', latestData = [];
    const tabs = document.querySelectorAll('#tabs button');
    const nickEl = document.getElementById('nickname');
    const filterEl = document.getElementById('filterSelect');
    const scheduleEl = document.getElementById('schedule');

    // Tab switching
    tabs.forEach(btn => btn.addEventListener('click', () => {
      tabs.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      currentDay = btn.dataset.day;
      loadSchedule();
    }));

    // Nickname input
    nickEl.addEventListener('change', e => {
      me = e.target.value.trim();
      render(latestData);
    });

    // Filter selection
    filterEl.addEventListener('change', () => render(latestData));

    // Load data via JSONP
    function loadSchedule() {
      scheduleEl.innerHTML = '<div class="loading">Loading…</div>';
      const s = document.createElement('script');
      s.src = `${backend}`
            + `?day=${encodeURIComponent(currentDay)}`
            + `&callback=gotData&nocache=${Date.now()}`;
      document.body.appendChild(s);
    }

    // JSONP callback
    function gotData(data) {
      latestData = data;
      populateFilterOptions(data);
      render(data);
    }

    // Populate dropdown with unique attendee names
    function populateFilterOptions(data) {
      const namesSet = new Set();
      data.forEach(item => {
        (item.Attendees || '').split(',').map(s=>s.trim()).forEach(n => { if(n) namesSet.add(n); });
      });
      // Clear existing options
      filterEl.innerHTML = '<option value="">All attendees</option>';
      Array.from(namesSet).sort().forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        filterEl.appendChild(opt);
      });
    }

    // Render with filtering and coloring
    function render(data) {
      const filterName = filterEl.value;
      scheduleEl.innerHTML = '';
      data.forEach(item => {
        const names = (item.Attendees || '')
                        .split(',').map(s=>s.trim()).filter(Boolean);
        // Apply filter: only show if no filter or name included
        if (filterName && !names.includes(filterName)) return;
        const joined = me && names.includes(me);
        const card = document.createElement('div');
        card.className = 'card';
        if (item.Color) card.style.borderLeftColor = item.Color;
        card.innerHTML = `
          <div class="artist">${item.Artist}</div>
          <div class="info">${item.Time} @ ${item.Stage}</div>
          <div class="attendees">👥 ${names.length?names.join(', '):'No one yet'}</div>
          <button class="${joined?'leave':'join'}"
                  onclick="toggle(${item.rowIndex}, event)">
            ${joined?'Leave':'Join'}
          </button>
        `;
        scheduleEl.appendChild(card);
      });
    }

    // Toggle attendance (single JSONP call)
    function toggle(row, ev) {
      if (!me) {
        alert('Please enter your nickname first.');
        return;
      }
      const btn = ev.currentTarget;
      btn.disabled = true;
      const orig = btn.textContent;
      btn.textContent = '⏳';

      const s = document.createElement('script');
      s.src = `${backend}`
            + `?action=toggle`
            + `&day=${encodeURIComponent(currentDay)}`
            + `&rowIndex=${row}`
            + `&nickname=${encodeURIComponent(me)}`
            + `&callback=gotData`;
      document.body.appendChild(s);

      setTimeout(()=>{ if (btn.disabled) { btn.disabled = false; btn.textContent = orig; } }, 5000);
    }

    // Initial load
    loadSchedule();
  </script>
</body>
</html>
