<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>B4L Lineup Planner</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Poppins', sans-serif; margin: 0; padding: 1em; background: #f0f0f0; }
    h2 { text-align: center; margin-bottom: 0.5em; }
    .sticky-container {
      position: sticky; top: 0; background: #f0f0f0;
      padding-bottom: 0.5em; z-index: 100;
    }
    #tabs { display: flex; gap: 0.5em; justify-content: center; margin-bottom: 0.5em; flex-wrap: wrap; }
    #tabs button {
      padding: 0.6em 1.2em; border: none; border-radius: 4px;
      background: #ddd; cursor: pointer; font-weight: 600;
    }
    #tabs button.active { background: #007bff; color: #fff; }
    #controls {
      display: flex; gap: 0.5em; flex-wrap: wrap; margin-bottom: 0.5em;
      justify-content: center;
    }
    #nickname, #filterSelect {
      padding: 0.6em; font-size: 1em; border-radius: 4px; border: 1px solid #ccc;
      width: 200px;
    }
    #warning {
      text-align: center; color: #fff; background: #e74c3c;
      padding: 0.5em; margin-bottom: 0.5em; display: none;
      border-radius: 4px;
    }
    .loading { text-align: center; color: #666; margin: 1em 0; }
    .card {
      background: #fff; padding: 1em; margin-bottom: 1em;
      border-radius: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      border-left: 6px solid transparent;
      transition: background 0.2s;
    }
    .card:hover { background: #fafafa; }
    .artist { font-size: 1.2em; font-weight: bold; }
    .info    { color: #555; margin: 0.5em 0; }
    .attendees { color: #333; font-size: 0.9em; margin: 0.5em 0; }
    button.join, button.leave {
      padding: 0.6em 1.2em; font-size: 1em; cursor: pointer;
      border: none; border-radius: 4px; font-weight: 600;
    }
    button.join { background: #28a745; color: #fff; }
    button.leave{ background: #dc3545; color: #fff; }
  </style>
</head>
<body>
  <h2>B4L Lineup Planner</h2>
  <div class="sticky-container">
    <div id="tabs"></div>
    <div id="controls">
      <input id="nickname" placeholder="Your nickname">
      <select id="filterSelect">
        <option value="">All attendees</option>
      </select>
    </div>
    <div id="warning"></div>
  </div>

  <div id="schedule"></div>

  <script>
    const backend = 'https://script.google.com/macros/s/AKfycby8Ikg95Fn4AKbKzHOdEBaNPNrISll8Z_PfrZs7hR5alJbMVkHybvguZY6d_tmSthA9bg/exec'; // your /exec URL

    let me = '', currentDay = '', latestData = [];
    const tabsEl = document.getElementById('tabs');
    const nickEl = document.getElementById('nickname');
    const filterEl = document.getElementById('filterSelect');
    const scheduleEl = document.getElementById('schedule');
    const warnEl = document.getElementById('warning');

    function initTabs() {
      const s = document.createElement('script');
      s.src = `${backend}?action=listDays&callback=renderTabs&nocache=${Date.now()}`;
      document.body.appendChild(s);
    }

    function renderTabs(days) {
      tabsEl.innerHTML = '';
      days.forEach((day, idx) => {
        const btn = document.createElement('button');
        btn.textContent = day;
        btn.dataset.day = day;
        if (idx === 0) { btn.classList.add('active'); currentDay = day; }
        btn.addEventListener('click', () => {
          document.querySelectorAll('#tabs button').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          currentDay = day;
          loadSchedule();
        });
        tabsEl.appendChild(btn);
      });
      loadSchedule();
    }

    nickEl.addEventListener('change', () => render(latestData));
    filterEl.addEventListener('change', () => render(latestData));

    function loadSchedule() {
      scheduleEl.innerHTML = '<div class="loading">Loading…</div>';
      const s = document.createElement('script');
      s.src = `${backend}`
            + `?day=${encodeURIComponent(currentDay)}`
            + `&callback=gotData&nocache=${Date.now()}`;
      document.body.appendChild(s);
    }

    function gotData(data) {
      latestData = data;
      populateFilterOptions(data);
      render(data);
      checkOverlap();
    }

    function populateFilterOptions(data) {
      const names = new Set();
      data.forEach(item =>
        (item.Attendees||'').split(',').map(s=>s.trim()).forEach(n=>n&&names.add(n))
      );
      filterEl.innerHTML = '<option value="">All attendees</option>';
      Array.from(names).sort().forEach(n => {
        const opt = document.createElement('option'); opt.value=n; opt.textContent=n;
        filterEl.appendChild(opt);
      });
    }

    function render(data) {
      scheduleEl.innerHTML = '';
      warnEl.style.display = 'none';
      const filterName = filterEl.value;
      const nick = nickEl.value.trim();
      data.forEach(item => {
        const list = (item.Attendees||'').split(',').map(s=>s.trim()).filter(Boolean);
        if (filterName && !list.includes(filterName)) return;
        const joined = nick && list.includes(nick);
        const card = document.createElement('div'); card.className='card';
        if (item.Color) card.style.borderLeftColor=item.Color;
        card.innerHTML = `
          <div class="artist">${item.Artist}</div>
          <div class="info">${item.Time} @ ${item.Stage}</div>
          <div class="attendees">👥 ${list.length?list.join(', '):'No one yet'}</div>
          <button class="${joined?'leave':'join'}" onclick="toggle(${item.rowIndex}, event)">
            ${joined?'Leave':'Join'}
          </button>`;
        scheduleEl.appendChild(card);
      });
    }

    function parseTime(str) {
      const [start, end] = str.split('–').map(s=>s.trim());
      const [hs, ms] = start.split(':').map(Number);
      const [he, me] = end.split(':').map(Number);
      return { start: hs*60+ms, end: he*60+me };
    }

    function checkOverlap() {
      const nick = nickEl.value.trim();
      if (!nick) return;
      const joinedItems = latestData.filter(item =>
        (item.Attendees||'').split(',').map(s=>s.trim()).includes(nick)
      );
      const times = joinedItems.map(item => ({
        name: item.Artist,
        ...parseTime(item.Time)
      })).sort((a,b)=>a.start - b.start);
      const overlaps = [];
      for (let i = 0; i < times.length; i++) {
        for (let j = i+1; j < times.length; j++) {
          if (times[j].start < times[i].end) {
            overlaps.push(`${times[i].name} & ${times[j].name}`);
          }
        }
      }
      if (overlaps.length) {
        warnEl.textContent = `⚠️ Overlap: ${[...new Set(overlaps)].join('; ')}`;
        warnEl.style.display = 'block';
      }
    }

    function toggle(row, ev) {
      const nick = nickEl.value.trim();
      if (!nick) return alert('Please enter your nickname first.');
      const btn = ev.currentTarget; btn.disabled=true; const orig = btn.textContent; btn.textContent='⏳';
      const s = document.createElement('script');
      s.src = `${backend}`
            + `?action=toggle`
            + `&day=${encodeURIComponent(currentDay)}`
            + `&rowIndex=${row}`
            + `&nickname=${encodeURIComponent(nick)}`
            + `&callback=gotData`;
      document.body.appendChild(s);
      setTimeout(()=>{if(btn.disabled){btn.disabled=false;btn.textContent=orig;}},5000);
    }

    // Initialize
    initTabs();
  </script>
</body>
</html>
